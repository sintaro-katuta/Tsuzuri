# 基本設計書：Tabiori-Scrap

要件定義に基づき、3日間で開発を完了させるための具体的な設計方針を定義します。

## 1. システム構成 (Tech Stack)
- **Framework**: Next.js 15 (App Router)
- **Language**: TypeScript
- **Styling**: CSS Modules (Vanilla CSS)
    - 理由: 柔軟なデザイン表現と、複雑なビルドツール依存の回避。
- **Database**: Supabase (PostgreSQL)
- **Auth**: Supabase Auth (Google Provider)
- **Storage**: Supabase Storage
- **Realtime**: Supabase Realtime (Postgres Changes)

## 2. データベース設計

### 2.1 ER図 (概念)
`users` (Supabase Auth) --(1:N)--> `trips` --(1:N)--> `timeline_items`

### 2.2 テーブル定義 (SQL)

#### `trips` テーブル
旅行自体を管理するテーブル。
- 共有URLのIDとして `share_id` (UUID) を使用し、これをURLの一部とする。

```sql
create table trips (
  id uuid primary key default gen_random_uuid(),
  title text not null,
  start_date date,
  end_date date,
  share_id uuid default gen_random_uuid() not null unique, -- URL共有用ID
  owner_id uuid references auth.users(id) not null,
  created_at timestamptz default now()
);

-- RLS: MVPのため「ログインユーザーは誰でもアクセス可」とし、アプリケーション側でシェアIDを知っているか（URLを知っているか）で制御する
alter table trips enable row level security;
create policy "Allow all authenticated access" on trips
  for all using (auth.role() = 'authenticated');
```

#### `timeline_items` テーブル
予定(PLAN)と写真(PHOTO)を一元管理する。

```sql
create table timeline_items (
  id uuid primary key default gen_random_uuid(),
  trip_id uuid references trips(id) on delete cascade not null,
  type text not null check (type in ('PLAN', 'PHOTO')),
  
  -- 共通項目
  title text, -- PLAN: タイトル, PHOTO: 未使用(orキャプション)
  time timestamptz not null, -- 予定時間 or 撮影/投稿時間
  memo text, -- メモ or コメント
  
  -- PLAN専用
  link_url text, -- Google Map URLなど
  is_completed boolean default false,
  
  -- PHOTO専用
  photo_path text, -- Supabase Storage Path
  
  created_by uuid references auth.users(id),
  created_at timestamptz default now()
);

-- RLS
alter table timeline_items enable row level security;
create policy "Allow all authenticated access" on timeline_items
  for all using (auth.role() = 'authenticated');
```

### 2.3 Storage設定
- **Bucket Name**: `trip-photos`
- **Policies**:
    - Public Access: Enabled (画像表示のため)
    - Upload/Select: Authenticated users only.

## 3. ディレクトリ・ファイル構成

```
/
├── app/
│   ├── layout.tsx         # 全体レイアウト（Font読み込み等）
│   ├── page.tsx           # LP & Googleログインボタン
│   ├── dashboard/
│   │   └── page.tsx       # 旅行一覧
│   ├── trips/
│   │   └── [share_id]/    # 共有IDでアクセス
│   │       ├── page.tsx   # メインのタイムライン画面
│   │       └── layout.tsx # Realtimeリスナー設置
│   └── globals.css        # ベーススタイル (Reset CSS variable)
├── components/
│   ├── ui/                # 共通UIパーツ (Button, Card)
│   ├── timeline/          # タイムライン関連コンポーネント
│   │   ├── Timeline.tsx
│   │   ├── PlanItem.tsx
│   │   └── PhotoItem.tsx
│   ├── forms/
│   │   └── AddItemForm.tsx # 追加モーダル/フォーム
│   └── Header.tsx
├── lib/
│   ├── supabase/
│   │   ├── client.ts      # Client Component用
│   │   └── server.ts      # Server Component/Action用
│   └── utils.ts
└── types/
    └── database.ts        # Supabase型定義
```

## 4. コンポーネント詳細設計

### `app/trips/[share_id]/page.tsx`
- **役割**: タイムラインのデータを取得し、表示する。
- **データ取得**: Server Component で `params.share_id` を元に `trips` と `timeline_items` を取得。
- **子コンポーネント**: `<Timeline initialItems={items} tripId={trip.id} />`

### `components/timeline/Timeline.tsx` (Client Component)
- **役割**: 項目のリスト表示とRealtime更新の反映。
- **State**: `items` (配列)。
- **Effect**: `supabase.channel` で `timeline_items` テーブルの変更（INSERT/UPDATE/DELETE）を監視し、Stateを更新する。

## 5. API / Server Actions設計
Next.js App RouterのServer Actionsを使用し、APIルートは作成しない。

- **`actions/trip.ts`**:
    - `createTrip(formData)`: 旅行作成
- **`actions/item.ts`**:
    - `addPlan(formData)`: 予定追加
    - `addPhoto(formData)`: 写真追加（StorageアップロードはClient側で行い、Pathのみ渡すのが効率的だが、今回はServer Actionで完結させるか、Clientアップロード→Server ActionでDB登録のフローとする） -> **Clientアップロード推奨** (UXよし)。

## 6. マイルストーン・タスク分解
要件定義のマイルストーンを具体加。

- **Day 1 (基盤)**
    - [ ] Next.js初期構築 & Supabase接続
    - [ ] Auth実装 (Login画面)
    - [ ] DBマイグレーション実行
    - [ ] `actions/trip.ts` 実装 & Dashboard画面作成
- **Day 2 (核心)**
    - [ ] `trips/[share_id]` ページ作成
    - [ ] タイムライン表示 (Plan/Photo混在ロジック)
    - [ ] アイテム追加フォーム実装
    - [ ] 画像アップロード実装
    - [ ] Realtime実装
- **Day 3 (仕上げ)**
    - [ ] ポラロイド風デザインの適用 (CSS)
    - [ ] レスポンシブ調整
    - [ ] バグ修正